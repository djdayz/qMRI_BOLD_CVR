# qMRI_BOLD_CVR
Dayoon Jung's MPhys Project about quantitative BOLD MRI studying cerebrovascular reactivity (CVR).

The Pipeline only including steps completed is: 

<img width="902" height="543" alt="Screenshot 2026-01-05 at 21 04 59" src="https://github.com/user-attachments/assets/8f7b0f9e-ca1f-4dd9-90a9-93795941f0f0" />

More steps would be added in the pipeline when they are completed. 

## Each file description:

**ETCO2.py**: 
Input: Physiological gas traces (txt)
Outputs: Columns for EtCO2 for each time (seconds) and baseline EtCO2 added to the input file. 
Also plots a graph of PctCO2, Detected EtCO2, Interpolated EtCO2, and EtCO2 baseline(slow drift).
 
<img width="1188" height="587" alt="Screenshot 2026-01-05 at 21 44 27" src="https://github.com/user-attachments/assets/5c93c06d-9319-4af3-a4b8-6fb8b0e5cb84" />
*The graph looks like with the data I used.*

**mcflirtbold.py**:
Input: 4D BOLD (nii)
Output: 4D motion corrected BOLD (nii)
Performs motion correction for BOLD using FSL MCFLIRT.

**eachvoxel_vs_etco2.py**:
Inputs: 4D motion corrected BOLD (nii), EtCO2 file (txt)
Plots a graph of BOLD signal versus EtCO2. There are 2 sliders to choose the voxel for the BOLD signals and to shift the EtCO2 to correlate the EtCO2 and BOLD signals. The purpose of this file is to verify if the global shift for EtCO2 is appropriate to use for generating CVR maps.

<img width="1092" height="635" alt="Screenshot 2026-01-05 at 22 13 31" src="https://github.com/user-attachments/assets/a7cae90e-acdb-431d-84f8-c81c5d56f0c8" />
*The graph looks like this with the data I used.* 

**etco2_smoothing.py**:
Input: EtCO2 file (txt)
Plots 3 graphs:
1) EtCO2 versus time (seconds); shows raw EtCO2, Smoothed EtCO2, normocapnia range, and hypercapnia range.
2) EtCO2 gradient versus time (seconds); shows gradient and the ramp threshold.
3) EtCO2 versus time (seconds); plots the stable normocapnia and the stable hypercapnia.
The purpose of this file is to find the appropriate smoothing second and ramp threshold for calculating the mean hypercapnia and mean normocapnia, which are needed for tCNR (temporal contrast-to-ratio) calculation.

<img width="1189" height="783" alt="Screenshot 2026-01-05 at 22 14 43" src="https://github.com/user-attachments/assets/ae9555e4-e63c-478a-9127-dbd7cd54eeef" />
*The graph looks like this with the data I used.*

**cvr_map.py**:
Inputs: 4D motion corrected BOLD (nii), mean BOLD mask (nii), EtCO2 file (txt)
Outputs: CVR magnitude map (nii), CVR delay map (nii), CVR magnitude map clipped (nii), CVR delay map clipped (nii), tCNR map (nii), R^2 map (nii), z-stat map (nii), z-score map (nii), standard error map (nii), positive value tCNR map (nii)
Compute CVR maps, statistical maps, and tCNR map. Mean BOLD mask was generated by using fslmaths on Terminal. 

<img width="1222" height="414" alt="Screenshot 2026-01-05 at 22 26 46" src="https://github.com/user-attachments/assets/098b7c54-6aa0-43c7-9029-e65ca43caff9" />
*CVR magnitude map clipped on fsleyes. (0 - 0.5)*

<img width="1217" height="409" alt="Screenshot 2026-01-05 at 22 29 13" src="https://github.com/user-attachments/assets/da0380e0-0989-42dc-9466-b93788fab956" />
*CVR delay map clipped on fsleyes. (0 - 80)*

<img width="1211" height="385" alt="Screenshot 2026-01-05 at 22 31 00" src="https://github.com/user-attachments/assets/e6dd3597-0104-4c30-8aca-8b258055f069" />
*positive value tCNR map on fsleyes. (0 - 4)* 

**t1wN4correction.py**:
Input: T1w (nii)
Performs ANTS N4 bias field correction on a raw T1W file. The shrink factor 3 was used here.

**bloodvesselsegmentation.py**:
Inputs: CVR magnitude map (nii), CVR delay map (nii), tCNR map (nii), mean BOLD mask eroded (nii), VCSF mask (nii), 4D motion corrected BOLD (nii)
Outputs: Blood vessel mask(nii), tSNR map (nii), tSNR mask(nii)
Compute blood vessel mask using the quality gate and clean up, tSNR (temporal signal-to-ratio) map, and tSNR mask. Mean BOLD mast eroded was generated by using fslmaths -ero on Terminal. 

**vcsf_from_roi.py**:
Inputs: CSF in BOLD space (nii), Hand-drawn ventricle ROI mask (nii)
Output: VCSF mask (nii)
Generates VCSF mask by computing CSF voxels corresponding to Hand-drawn ventricle ROI mask. Hand-drawn ventricle ROI mask was created by manually drawing the ventricle mask on CSF image on fsleyes. CSF in t1w space was generated by using FSL FAST command on Terminal. CSF in t1w space was registered to BOLD space by using FSL FLIRT applyxfm command applying t1w to bold space matrix, which was computed by registering t1w image to BOLD image by using FLIRT on Terminal. 

## References

1) Sleight E, Stringer MS, Mitchell I, Murphy M, Marshall I, Wardlaw JM, Thrippleton MJ. Cerebrovascular reactivity measurements using 3T BOLD MRI and a fixed inhaled CO2 gas challenge: Repeatability and impact of processing strategy. Front Physiol. 2023 Feb 6;14:1070233. doi: 10.3389/fphys.2023.1070233. PMID: 36814481; PMCID: PMC9939770.
- This is the literature I followed and got the data set.
  
2) S.M. Smith, M. Jenkinson, M.W. Woolrich, C.F. Beckmann, T.E.J. Behrens, H. Johansen-Berg, P.R. Bannister, M. De Luca, I. Drobnjak, D.E. Flitney, R. Niazy, J. Saunders, J. Vickers, Y. Zhang, N. De Stefano, J.M. Brady, and P.M. Matthews. Advances in functional and structural MR image analysis and implementation as FSL. NeuroImage, 23(S1):208-19, 2004
- FSL reference.


